# Лабораторная работа №2. Docker

[Лекция: L2. Docker](../lectures/ait2_lec2.ipynb).

## Задание 1

На базе образа [Ubuntu 22.04](https://hub.docker.com/_/ubuntu) создать Docker контейнер со сборкой OpenCV с non free 
contrib модулями (пример 3 из лекции).
- Версия Убунты: 22.04
- OpenCV: 4.8.0
- CUDA: 12.2

1. Отредактировать скрипт сборки [build.sh](ait2_l2/build.sh), заменить значения:
   - `image_tag` - название тега;
   - `build_thread_count` - количество потоков для сборки библиотеки, лучше указать $n - 1$, где $n$ - количество 
   *физических* ядер CPU.
2. C CUDA возможны различные приколы при установке, особенно на старые релизы типа 18.04. Если в системе нет GPU Nvidia,
   то установку CUDA можно вырезать из скрипта сборки и докер файла.
3. Изменить права доступа, выдать разрешение для запуска скриптов `build.sh`, `build_env.sh`:
   ```bash
   chmod +x build.sh
   chmod +x build_env.sh
   ```
4. Дописать в конец докер файла (перед `CMD`) команды для установки необходимых либ Python 3.
5. Запустить `build.sh` для сборки контейнера.
6. Реализовать [алгоритм обработки изображений](data/ait2_l2/sub_task_opencv.md), скрипт на питоне положить в папку на хосте.
7. Запустить контейнер командой:
   ```bash
   docker run -v <путь на хосте>:<путь внутри контейнера> -it <имя тега>
   ```
8. Запустить скрипт с реализованным алгоритмом в контейнере в примонитрованной внутри контейнера папке. 
   Результат обработки сохранить в локальной директории контейнера.
9. Убедиться в появлении результата в директории хоста.

## Задание 2.

Запустить предобученную нейронку с использованием `pytorch` внутри контейнера. Для создания контейнера использовать 
`Docker Compose`.

1. Собрать контейнер с установленным PyTorch (CPU или GPU версия).
  > Проще всего собрать контейнер на базе подготовленного образа с Docker Hub, например, 
    [pytorch:2.1.0-cuda11.8-cudnn8-devel](https://hub.docker.com/layers/pytorch/pytorch/2.1.0-cuda11.8-cudnn8-devel/images/sha256-558b78b9a624969d54af2f13bf03fbad27907dbb6f09973ef4415d6ea24c80d9?context=explore).
    Можно и из обычного образа, например, Убунты. Тогда нужно будет установить CUDA определенной версии 
  при сборке контейнера, а на самом хосте поставить [NVIDIA Container Toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html). 
2. Написать [скрипт обработки изображений с использованием нейросети](data/ait2_l2/sub_task_pytorch.md). 
   Можно выбрать любую понравившуюся модель/задачу обработки изображения нейросетью. 
   > У [niconielsen32](https://github.com/niconielsen32) в репах есть целая подборка различных заготовок по 
     [Computer Vision](https://github.com/niconielsen32/ComputerVision), например, 
     [вычисление карты глубин по изображению](https://github.com/niconielsen32/ComputerVision/blob/master/MonocularDepth/midasDepthMap.py).
3. Запустить контейнер командой:
   ```bash
   docker compose -f <имя_конфига.yaml> up
   ```
4. Запустить скрипт с реализованным алгоритмом в контейнере в примонитрованной внутри контейнера папке. 
   Результат обработки сохранить в локальной директории контейнера.
5. Убедиться в появлении результата в директории хоста.

## Описание полученных результатов 

В первой чати лаборатоной работы был собран и запущен Docker контейнер на базе образа Ubuntu 22.04. Реализован и запущен внутри контейнера алгоритм обработки изображения. Результирующие изображения сохранены в директорий хоста и в локальный директорий контейнера.


Обработка изображения включала следующие этапы:

1. Преобразовать изображение в градации серого.
2. Построить гистограмму значений яркости пикселей.
3. Сделать пороговую обработку методом Otsu - функция OpenCV (пороговое значение указано на рисунке 1).
4. Т.к. исходное изображение обладает очень слабым контрастом, то последний шаг - повысить контрастность изображения.

_________________________
Рисунок 1 - Результат запуска контейнера 

<img src="https://github.com/MariaShaiina/ds_cours_2023/blob/9a4bebb15bbeaa559b363ffcca51c2b92f5946a2/lab2-Docker/img/py_res.jpg">

_________________________
Рисунок 2 - Исходное изображение

<img src="https://github.com/MariaShaiina/ds_cours_2023/blob/9a4bebb15bbeaa559b363ffcca51c2b92f5946a2/lab2-Docker/img/orig_img.jpg">

_________________________
Рисунок 3 - Пороговая обработка

<img src="https://github.com/MariaShaiina/ds_cours_2023/blob/9a4bebb15bbeaa559b363ffcca51c2b92f5946a2/lab2-Docker/img/threshold%20img.jpg">

_________________________
Рисунок 4 - Результат обработки

<img src="https://github.com/MariaShaiina/ds_cours_2023/blob/9a4bebb15bbeaa559b363ffcca51c2b92f5946a2/lab2-Docker/img/result%20img.jpg">

_________________________

<img src="https://github.com/MariaShaiina/ds_cours_2023/blob/9a4bebb15bbeaa559b363ffcca51c2b92f5946a2/lab2-Docker/img/results_1.png">



Во второй части был собрать контейнер с установленным PyTorch
